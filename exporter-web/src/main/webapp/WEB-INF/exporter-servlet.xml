<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:tx="http://www.springframework.org/schema/tx"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx.xsd">

  <tx:annotation-driven/>

  <!-- Spring MVC >=3.1 -->
  <bean class="org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping"/>
  <bean class="org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter"/>
  <bean class="org.springframework.web.servlet.mvc.method.annotation.ExceptionHandlerExceptionResolver"/>
  <bean class="org.springframework.web.servlet.mvc.support.DefaultHandlerExceptionResolver"/>
  <bean class="org.springframework.web.servlet.mvc.annotation.ResponseStatusExceptionResolver"/>

  <!-- Generic utilities used throughout -->
  <bean id="baseUri" class="java.net.URI">
    <constructor-arg value="http://localhost:8080/data"/>
  </bean>
  <bean id="conversionService" class="org.springframework.core.convert.support.DefaultConversionService"/>
  <bean id="transactionTemplate" class="org.springframework.transaction.support.TransactionTemplate">
    <property name="transactionManager" ref="transactionManager"/>
  </bean>

  <!-- Metadata for JPA Repositories -->
  <bean class="org.springframework.orm.jpa.support.PersistenceAnnotationBeanPostProcessor"/>
  <bean id="jpaRepositoryMetadata" class="org.springframework.data.services.repository.jpa.JpaRepositoryMetadata"/>
  <bean id="repositoryResolver" class="org.springframework.data.services.repository.jpa.JpaRepositoryResolver">
    <constructor-arg ref="baseUri"/>
    <constructor-arg>
      <list>
        <ref bean="jpaRepositoryMetadata"/>
      </list>
    </constructor-arg>
  </bean>
  <bean id="repositoryEntityResolver"
        class="org.springframework.data.services.repository.jpa.JpaRepositoryEntityResolver">
    <constructor-arg ref="baseUri"/>
    <constructor-arg ref="jpaRepositoryMetadata"/>
    <constructor-arg ref="conversionService"/>
    <constructor-arg ref="transactionTemplate"/>
  </bean>
  <bean id="repositoryEntityLinkAwareResolver"
        class="org.springframework.data.services.repository.jpa.JpaEntityLinkAwareResolver">
    <constructor-arg ref="baseUri"/>
    <constructor-arg ref="jpaRepositoryMetadata"/>
    <constructor-arg ref="transactionTemplate"/>
  </bean>

  <!-- The Exporter -->
  <bean class="org.springframework.data.services.web.exporter.SimpleResourceExporterController">
    <property name="baseUri" ref="baseUri"/>
    <property name="readResolvers">
      <list>
        <ref bean="repositoryResolver"/>
        <ref bean="repositoryEntityResolver"/>
        <ref bean="repositoryEntityLinkAwareResolver"/>
        <bean class="org.springframework.data.services.web.exporter.QueryStringPropertyResolver">
          <constructor-arg value="p"/>
        </bean>
      </list>
    </property>
  </bean>

  <!-- Handle rendering in different representations -->
  <bean class="org.springframework.web.servlet.view.ContentNegotiatingViewResolver">
    <property name="defaultContentType" value="application/json"/>
    <property name="defaultViews">
      <list>
        <!--bean class="org.springframework.web.servlet.view.json.MappingJacksonJsonView"/-->
        <bean class="org.springframework.data.services.web.JsonView">
          <constructor-arg value="application/x-spring-data+json"/>
        </bean>
      </list>
    </property>
  </bean>

</beans>